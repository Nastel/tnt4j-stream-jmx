<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Stream-JMX by Nastel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Stream-JMX</h1>
      <h2 class="project-tagline">A Lightweight framework to stream and monitor JMX metrics</h2>
      <a href="https://github.com/Nastel/tnt4j-stream-jmx" class="btn">View on GitHub</a>
      <a href="https://github.com/Nastel/tnt4j-stream-jmx/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/Nastel/tnt4j-stream-jmx/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="stream-jmx" class="anchor" href="#stream-jmx" aria-hidden="true"><span class="octicon octicon-link"></span></a>Stream-JMX</h1>

<p>A Lightweight framework to stream and monitor JMX metrics. </p>

<p>Stream JMX metrics to: </p>

<ul>
<li>Central monitoring server</li>
<li>File, socket, log4j</li>
<li>User defined destination</li>
</ul>

<p>These metrics can be used to monitor health, performance and availability of your JVMs and applications.
Use Stream-JMX to embed a monitoring agent within your application and monitor memory, GC activity, CPU as
well as user defined MBeans.</p>

<p>Here is what you can do with Stream-JMX:</p>

<ul>
<li>Periodic JVM heartbeat</li>
<li>Monitor memory utilization, GC activity, memory leaks</li>
<li>High/Low, normal vs. abnormal CPU usage</li>
<li>Monitor threading, runtime and other JVM performance metrics</li>
<li>Monitor standard and custom MBean attributes</li>
<li>Conditional actions based on MBean attribute values</li>
<li>Conditional streaming based on custom filters</li>
<li>Application state dumps on VM shut-down for diagnostics</li>
</ul>

<h1>
<a id="why-stream-jmx" class="anchor" href="#why-stream-jmx" aria-hidden="true"><span class="octicon octicon-link"></span></a>Why Stream-JMX</h1>

<p>Stream-JMX provides and easy, lightweight and secure way to stream and monitor JMX metrics from within
java runtime containers.</p>

<ul>
<li>Stream JMX metrics out of the JVM container (vs. polling from outside/remote)</li>
<li>Makes it easy to monitor farms of JMVs, application servers</li>
<li>Reduce cyber security risk: No need to enable remote JMX, SSL, security, ports, firewalls</li>
<li>Integration with monitoring tools for alerting, pro-active monitoring (AutoPilot M6)</li>
<li>Integration with cloud analytics tools (<a href="https://www.jkoolcloud.com">https://www.jkoolcloud.com</a> via JESL)</li>
<li>Integration with log4j, slf4j, jkoocloud (via TNT4J event sinks)</li>
<li>Embedded application state dump framework for diagnostics</li>
<li>Easily build your own extensions, monitors</li>
</ul>

<p><b>NOTE:</b> JESL provides a way to stream events generated by Stream-JMX to jKool Cloud. 
For more information on JESL visit: <a href="http://nastel.github.io/JESL/">http://nastel.github.io/JESL/</a></p>

<h1>
<a id="using-stream-jmx" class="anchor" href="#using-stream-jmx" aria-hidden="true"><span class="octicon octicon-link"></span></a>Using Stream-JMX</h1>

<p>It is simple: (1) run Stream-JMX as a <code>-javaagent</code> or (2) imbed Stream-JMX code into your application.</p>

<p>Running Stream-JMX as javaagent:</p>

<div class="highlight highlight-java"><pre>java <span class="pl-k">-</span>javaagent<span class="pl-k">:</span>tnt4j<span class="pl-k">-</span>stream<span class="pl-k">-</span>jmx<span class="pl-k">.</span>jar<span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>*:*!30000<span class="pl-pds">"</span></span> <span class="pl-k">-</span><span class="pl-smi">Dtnt4j</span><span class="pl-k">.</span>config<span class="pl-k">=</span>tnt4j<span class="pl-k">.</span>properties <span class="pl-k">-</span>classpath <span class="pl-s"><span class="pl-pds">"</span>tnt4j-stream-jmx.jar;lib/tnt4j-api-final-all.jar<span class="pl-pds">"</span></span> your<span class="pl-k">.</span>class<span class="pl-k">.</span>name your<span class="pl-k">-</span>args</pre></div>

<p>Imbed Stream-JMX code into your application:</p>

<div class="highlight highlight-java"><pre><span class="pl-c">// obtain SamplerFactory instance</span>
<span class="pl-smi">SamplerFactory</span> factory <span class="pl-k">=</span> <span class="pl-smi">DefaultSamplerFactory</span><span class="pl-k">.</span>getInstance();
<span class="pl-c">// create an instance of the sampler that will sample mbeans</span>
<span class="pl-smi">Sampler</span> sampler <span class="pl-k">=</span> factory<span class="pl-k">.</span>newInstance();
<span class="pl-c">// schedule collection (ping) for given MBean filter and 30000 ms sampling period</span>
sampler<span class="pl-k">.</span>setSchedule(<span class="pl-smi">Sampler</span><span class="pl-c1"><span class="pl-k">.</span>JMX_FILTER_ALL</span>, <span class="pl-c1">30000</span>)<span class="pl-k">.</span>run();</pre></div>

<p><b>NOTE:</b> <code>setSchedule(..).run()</code> sequence must be called to run the schedule. <code>setSchedule(..)</code> just sets the
scheduling parameters, <code>run()</code> executes the schedule.</p>

<p>To schedule metric collection for a specific MBean server:</p>

<div class="highlight highlight-java"><pre><span class="pl-c">// obtain SamplerFactory instance</span>
<span class="pl-smi">SamplerFactory</span> factory <span class="pl-k">=</span> <span class="pl-smi">DefaultSamplerFactory</span><span class="pl-k">.</span>getInstance();
<span class="pl-c">// create an instance of the sampler that will sample mbeans</span>
<span class="pl-smi">Sampler</span> sampler <span class="pl-k">=</span> factory<span class="pl-k">.</span>newInstance(<span class="pl-smi">ManagementFactory</span><span class="pl-k">.</span>getPlatformMBeanServer());
<span class="pl-c">// schedule collection (ping) for given MBean filter and 30000 ms sampling period</span>
sampler<span class="pl-k">.</span>setSchedule(<span class="pl-smi">Sampler</span><span class="pl-c1"><span class="pl-k">.</span>JMX_FILTER_ALL</span>, <span class="pl-c1">30000</span>)<span class="pl-k">.</span>run();</pre></div>

<p>Below is an example of how to sample all registered mbean servers:</p>

<div class="highlight highlight-java"><pre><span class="pl-c">// obtain SamplerFactory instance</span>
<span class="pl-smi">SamplerFactory</span> factory <span class="pl-k">=</span> <span class="pl-smi">DefaultSamplerFactory</span><span class="pl-k">.</span>getInstance();
<span class="pl-c">// find other registered mbean servers</span>
<span class="pl-k">ArrayList&lt;<span class="pl-smi">MBeanServer</span>&gt;</span> mlist <span class="pl-k">=</span> <span class="pl-smi">MBeanServerFactory</span><span class="pl-k">.</span>findMBeanServer(<span class="pl-c1">null</span>);
<span class="pl-k">for</span> (<span class="pl-smi">MBeanServer</span> server<span class="pl-k">:</span> mlist) {
    <span class="pl-smi">Sampler</span> jmxp <span class="pl-k">=</span> factory<span class="pl-k">.</span>newInstance(server);
    jmxp<span class="pl-k">.</span>setSchedule(<span class="pl-smi">Sampler</span><span class="pl-c1"><span class="pl-k">.</span>JMX_FILTER_ALL</span>, <span class="pl-c1">30000</span>)<span class="pl-k">.</span>run();
}</pre></div>

<p>Alternatively, Stream-JMX provides a helper class <code>SamplingAgent</code> that lets you schedule sampling for all registered <code>MBeanServer</code> instances.</p>

<div class="highlight highlight-java"><pre><span class="pl-smi">SamplingAgent</span><span class="pl-k">.</span>sample(<span class="pl-smi">Sampler</span><span class="pl-c1"><span class="pl-k">.</span>JMX_FILTER_ALL</span>, <span class="pl-c1">60000</span>, <span class="pl-smi">TimeUnit</span><span class="pl-c1"><span class="pl-k">.</span>MILLISECONDS</span>);</pre></div>

<p><b>NOTE:</b> Sampled MBean attributes and associated values are stored in a collection of <code>Snapshot</code> objects stored within <code>Activity</code> instance. Current <code>Activity</code> instance can be obtained via <code>AttributeSample</code> passed when calling listeners such as <code>AttributeCondition</code>, <code>SampleListener</code>. Snapshots can be accessed using <code>Activity.getSnapshots()</code> method call.</p>

<p><b>NOTE:</b> Sampled output is written to underlying tnt4j event sink configured in <code>tnt4j.properties</code> file. Sink destinations could be a file, socket, log4j, user defined event sink implementations. </p>

<p>For more information on TNT4J and <code>tnt4j.properties</code> see (<a href="https://github.com/Nastel/TNT4J/wiki/Getting-Started">https://github.com/Nastel/TNT4J/wiki/Getting-Started</a>).</p>

<h2>
<a id="running-stream-jmx-as-standalone-app" class="anchor" href="#running-stream-jmx-as-standalone-app" aria-hidden="true"><span class="octicon octicon-link"></span></a>Running Stream-JMX as standalone app</h2>

<p>Example below runs <code>SamplingAgent</code> helper class as a standalone java application with a given MBean filter <code>"*:*"</code>, sampling period in milliseconds (<code>10000</code>), and time to run in milliseconds (<code>60000</code>):</p>

<div class="highlight highlight-java"><pre>java <span class="pl-k">-</span><span class="pl-smi">Dorg</span><span class="pl-k">.</span>tnt4j<span class="pl-k">.</span>stream<span class="pl-k">.</span>jmx<span class="pl-k">.</span>agent<span class="pl-k">.</span>trace<span class="pl-k">=</span><span class="pl-c1">true</span> <span class="pl-k">-</span>classpath <span class="pl-s"><span class="pl-pds">"</span>tnt4j-stream-jmx.jar;lib/tnt4j-api-final-all.jar<span class="pl-pds">"</span></span> <span class="pl-smi">org.tnt4j.stream.jmx<span class="pl-k">.</span>SamplingAgent</span> <span class="pl-s"><span class="pl-pds">"</span>*:*<span class="pl-pds">"</span></span> <span class="pl-c1">10000</span> <span class="pl-c1">60000</span></pre></div>

<h2>
<a id="running-stream-jmx-as--javaagent" class="anchor" href="#running-stream-jmx-as--javaagent" aria-hidden="true"><span class="octicon octicon-link"></span></a>Running Stream-JMX as -javaagent</h2>

<p>Stream-JMX can be invoked as <code>-javaagent</code> without changing your application code:</p>

<div class="highlight highlight-java"><pre>java <span class="pl-k">-</span>javaagent<span class="pl-k">:</span>tnt4j<span class="pl-k">-</span>stream<span class="pl-k">-</span>jmx<span class="pl-k">.</span>jar<span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>*:*!30000<span class="pl-pds">"</span></span> <span class="pl-k">-</span><span class="pl-smi">Dtnt4j</span><span class="pl-k">.</span>config<span class="pl-k">=</span>tnt4j<span class="pl-k">.</span>properties <span class="pl-k">-</span>classpath <span class="pl-s"><span class="pl-pds">"</span>tnt4j-stream-jmx.jar;lib/tnt4j-api-final-all.jar<span class="pl-pds">"</span></span> your<span class="pl-k">.</span>class<span class="pl-k">.</span>name your<span class="pl-k">-</span>args</pre></div>

<p>The options are <code>-javaagent:tnt4j-stream-jmx.jar="mbean-filter!sample-time-ms"</code>, classpath must include pingjmx jar files as well as locations of log4j and tnt4j configuration files.</p>

<h2>
<a id="where-do-the-streams-go" class="anchor" href="#where-do-the-streams-go" aria-hidden="true"><span class="octicon octicon-link"></span></a>Where do the streams go?</h2>

<p>Stream-JMX streams all collected metrics based on a scheduled interval via TNT4J event streaming framework.
All streams are written into TNT4J event sinks defined in <code>tnt4j.properties</code> file which is defined by <code>-Dtnt4j.config=tnt4j.properties</code> property. </p>

<p>To stream Stream-JMX to jkool cloud (<a href="https://www.jkoolcloud.com">https://www.jkoolcloud.com</a>): (Requires JESL libraries (see <a href="https://github.com/Nastel/JESL">https://github.com/Nastel/JESL</a>))</p>

<pre><code>;Stanza used for Stream-JMX sources
{
    source: org.tnt4j.stream.jmx
    source.factory: com.nastel.jkool.tnt4j.source.SourceFactoryImpl
    source.factory.GEOADDR: NewYork
    source.factory.DATACENTER: YourDC
    source.factory.RootFQN: SERVER=?#DATACENTER=?#GEOADDR=? 
    source.factory.RootSSN: tnt4j-stream-jmx    

    tracker.factory: com.nastel.jkool.tnt4j.tracker.DefaultTrackerFactory
    dump.sink.factory: com.nastel.jkool.tnt4j.dump.DefaultDumpSinkFactory

    ; Event sink definition where all streams are recorded
    event.sink.factory: com.nastel.jkool.tnt4j.sink.BufferedEventSinkFactory

    ; Event Sink configuration for streaming to jKool Cloud
    ; event.sink.factory.EventSinkFactory.Filename: jkoocloud.json
    event.sink.factory.EventSinkFactory.Url: http://data.jkoolcloud.com:6580
    event.sink.factory.EventSinkFactory.Token: ACCESS-TOKEN
    event.formatter: com.nastel.jkool.tnt4j.format.JSONFormatter

    ; Configure default sink filter 
    event.sink.factory.Filter: com.nastel.jkool.tnt4j.filters.EventLevelTimeFilter
    event.sink.factory.Filter.Level: TRACE

    tracking.selector: com.nastel.jkool.tnt4j.selector.DefaultTrackingSelector
    tracking.selector.Repository: com.nastel.jkool.tnt4j.repository.FileTokenRepository
}
</code></pre>

<p>Below is an example of TNT4J stream definition where all Stream-JMX streams are written into a socket event sink
<code>com.nastel.jkool.tnt4j.sink.SocketEventSinkFactory</code>, formatted by <code>org.tnt4j.stream.jmx.format.FactNameValueFormatter</code> :</p>

<pre><code>;Stanza used for Stream-JMX sources
{
    source: org.tnt4j.stream.jmx
    source.factory: com.nastel.jkool.tnt4j.source.SourceFactoryImpl
    source.factory.GEOADDR: NewYork
    source.factory.DATACENTER: YourDC
    source.factory.RootFQN: SERVER=?#DATACENTER=?#GEOADDR=? 
    source.factory.RootSSN: tnt4j-stream-jmx    

    tracker.factory: com.nastel.jkool.tnt4j.tracker.DefaultTrackerFactory
    dump.sink.factory: com.nastel.jkool.tnt4j.dump.DefaultDumpSinkFactory

    ; Event sink definition where all streams are recorded

    event.sink.factory: com.nastel.jkool.tnt4j.sink.BufferedEventSinkFactory
    event.sink.factory.EventSinkFactory: com.nastel.jkool.tnt4j.sink.SocketEventSinkFactory
    event.sink.factory.EventSinkFactory.eventSinkFactory: com.nastel.jkool.tnt4j.sink.NullEventSinkFactory
    event.sink.factory.EventSinkFactory.Host: localhost
    event.sink.factory.EventSinkFactory.Port: 6060

    ; Configure default sink filter 
    event.sink.factory.Filter: com.nastel.jkool.tnt4j.filters.EventLevelTimeFilter
    event.sink.factory.Filter.Level: TRACE

    event.formatter: org.tnt4j.stream.jmx.format.FactNameValueFormatter
    tracking.selector: com.nastel.jkool.tnt4j.selector.DefaultTrackingSelector
    tracking.selector.Repository: com.nastel.jkool.tnt4j.repository.FileTokenRepository
}
</code></pre>

<p>To stream Stream-JMX into a log file <code>MyStream.log</code>:</p>

<pre><code>;Stanza used for Stream-JMX sources
{
    source: org.tnt4j.stream.jmx
    source.factory: com.nastel.jkool.tnt4j.source.SourceFactoryImpl
    source.factory.GEOADDR: NewYork
    source.factory.DATACENTER: YourDC
    source.factory.RootFQN: SERVER=?#DATACENTER=?#GEOADDR=? 
    source.factory.RootSSN: tnt4j-stream-jmx    

    tracker.factory: com.nastel.jkool.tnt4j.tracker.DefaultTrackerFactory
    dump.sink.factory: com.nastel.jkool.tnt4j.dump.DefaultDumpSinkFactory

    ; Event sink definition where all streams are recorded
    event.sink.factory: com.nastel.jkool.tnt4j.sink.BufferedEventSinkFactory
    event.sink.factory.EventSinkFactory: com.nastel.jkool.tnt4j.sink.FileEventSinkFactory
    event.sink.factory.EventSinkFactory.FileName: MyStream.log

    ; Configure default sink filter 
    event.sink.factory.Filter: com.nastel.jkool.tnt4j.filters.EventLevelTimeFilter
    event.sink.factory.Filter.Level: TRACE

    event.formatter: org.tnt4j.stream.jmx.format.FactNameValueFormatter
    tracking.selector: com.nastel.jkool.tnt4j.selector.DefaultTrackingSelector
    tracking.selector.Repository: com.nastel.jkool.tnt4j.repository.FileTokenRepository
}
</code></pre>

<p>You can write your own custom event sinks (HTTPS, HTTP, etc) and your own stream formatters without having to change Stream-JMX code or your application. TNT4J comes with a set of built-in event sink implementations such as: </p>

<ul>
<li>
<code>com.nastel.jkool.tnt4j.logger.Log4JEventSinkFactory</code> -- log4j</li>
<li>
<code>com.nastel.jkool.tnt4j.sink.BufferedEventSinkFactory</code> -- buffered sink</li>
<li>
<code>com.nastel.jkool.tnt4j.sink.FileEventSinkFactory</code> - standard log file</li>
<li>
<code>com.nastel.jkool.tnt4j.sink.SocketEventSinkFactory</code> -- socket (tcp/ip)</li>
<li>
<code>com.nastel.jkool.tnt4j.sink.NullEventSinkFactory</code> -- null (empty)</li>
</ul>

<h2>
<a id="auto-generating-application-state-dump" class="anchor" href="#auto-generating-application-state-dump" aria-hidden="true"><span class="octicon octicon-link"></span></a>Auto-generating application state dump</h2>

<p>Stream-JMX is utilizing TNT4J state dump capability to generate application state dumps</p>

<p>(1) Dump on VM shut-down:</p>

<div class="highlight highlight-java"><pre>java <span class="pl-k">-</span><span class="pl-smi">Dtnt4j</span><span class="pl-k">.</span>dump<span class="pl-k">.</span>on<span class="pl-k">.</span>vm<span class="pl-k">.</span>shutdown<span class="pl-k">=</span><span class="pl-c1">true</span> <span class="pl-k">-</span><span class="pl-smi">Dtnt4j</span><span class="pl-k">.</span>dump<span class="pl-k">.</span>provider<span class="pl-k">.</span><span class="pl-k">default</span><span class="pl-k">=</span><span class="pl-c1">true</span> <span class="pl-k">-</span><span class="pl-smi">Dtnt4j</span><span class="pl-k">.</span>dump<span class="pl-k">.</span>folder<span class="pl-k">=</span><span class="pl-c1">.</span><span class="pl-k">/</span> <span class="pl-c1">...</span></pre></div>

<p>(2) Dump on uncaught thread exceptions:</p>

<div class="highlight highlight-java"><pre>java <span class="pl-k">-</span><span class="pl-smi">Dtnt4j</span><span class="pl-k">.</span>dump<span class="pl-k">.</span>on<span class="pl-k">.</span>exceptionn<span class="pl-k">=</span><span class="pl-c1">true</span> <span class="pl-k">-</span><span class="pl-smi">Dtnt4j</span><span class="pl-k">.</span>dump<span class="pl-k">.</span>provider<span class="pl-k">.</span><span class="pl-k">default</span><span class="pl-k">=</span><span class="pl-c1">true</span> <span class="pl-k">-</span><span class="pl-smi">Dtnt4j</span><span class="pl-k">.</span>dump<span class="pl-k">.</span>folder<span class="pl-k">=</span><span class="pl-c1">.</span><span class="pl-k">/</span> <span class="pl-c1">...</span></pre></div>

<p><code>-Dtnt4j.dump.folder=./</code> specifies the destination folder where dump (.dump) files will be created (default is current working directory).</p>

<p>By default Stream-JMX will generate dumps with the following info:</p>

<ul>
<li>Java Properties Dump -- <code>PropertiesDumpProvider</code>
</li>
<li>Java Runtime Dump -- <code>MXBeanDumpProvider</code>
</li>
<li>Thread Stack Dump -- <code>ThreadDumpProvider</code>
</li>
<li>Thread Deadlock Dump -- <code>ThreadDumpProvider</code>
</li>
<li>Logging Statistics Dump -- <code>LoggerDumpProvider</code>
</li>
</ul>

<p>You may create your own dump providers and handlers (<a href="https://github.com/Nastel/TNT4J/wiki/Getting-Started#application-state-dumps">https://github.com/Nastel/TNT4J/wiki/Getting-Started#application-state-dumps</a>)</p>

<h2>
<a id="overriding-default-samplerfactory" class="anchor" href="#overriding-default-samplerfactory" aria-hidden="true"><span class="octicon octicon-link"></span></a>Overriding default <code>SamplerFactory</code>
</h2>

<p><code>SamplerFactory</code> instances are used to generate <code>Sampler</code> implementation for a specific runtime environment. Stream-JMX supplies sampler and ping factories for standard JVMs, JBoss,
WebSphere Application Server. You may want to override default <code>SamplerFactory</code> with your own or an altenative by specifying:</p>

<div class="highlight highlight-java"><pre>java <span class="pl-k">-</span><span class="pl-smi">Dorg</span><span class="pl-k">.</span>tnt4j<span class="pl-k">.</span>stream<span class="pl-k">.</span>jmx<span class="pl-k">.</span>factory<span class="pl-k">=</span><span class="pl-smi">org.tnt4j.stream.jmx<span class="pl-k">.</span>PlatformSamplerFactory</span> <span class="pl-c1">...</span></pre></div>

<p><code>SamplerFactory</code> is used to generate instances of the underlying sampler implementatons (objects that provide sampling of underlying mbeans).</p>

<div class="highlight highlight-java"><pre><span class="pl-c">// return default or user defined SamplerFactory implementation</span>
<span class="pl-smi">SamplerFactory</span> factory <span class="pl-k">=</span> <span class="pl-smi">DefaultSamplerFactory</span><span class="pl-k">.</span>getInstance();
<span class="pl-c1">...</span></pre></div>

<h2>
<a id="managing-sample-behavior" class="anchor" href="#managing-sample-behavior" aria-hidden="true"><span class="octicon octicon-link"></span></a>Managing Sample Behavior</h2>

<p>Stream-JMX provides a way to intercept sampling events such as pre, during an post for each sample run and control sample behavior. See <code>SampleListener</code> interface for more details. Applications may register more than one listener per <code>Sampler</code>. Each listener is called in registration order.</p>

<p>In addition to intercepting sample events, applications may want to control how one ore more attributes are sampled and whether each sample is reported/logged. See example below:</p>

<div class="highlight highlight-java"><pre><span class="pl-c">// return default or user defined SamplerFactory implementation</span>
<span class="pl-smi">SamplerFactory</span> factory <span class="pl-k">=</span> <span class="pl-smi">DefaultSamplerFactory</span><span class="pl-k">.</span>getInstance();
<span class="pl-c">// create an instance of the sampler that will sample mbeans</span>
<span class="pl-smi">Sampler</span> sampler <span class="pl-k">=</span> factory<span class="pl-k">.</span>newInstance();
sampler<span class="pl-k">.</span>setSchedule(<span class="pl-smi">Sampler</span><span class="pl-c1"><span class="pl-k">.</span>JMX_FILTER_ALL</span>, <span class="pl-c1">30000</span>)<span class="pl-k">.</span>addListener(<span class="pl-k">new</span> <span class="pl-smi">MySampleListener</span>()))<span class="pl-k">.</span>run();</pre></div>

<p>Below is a sample of what <code>MySampleListener</code> may look like:</p>

<div class="highlight highlight-java"><pre><span class="pl-k">class</span> <span class="pl-en">MySampleListener</span> <span class="pl-k">implements</span> <span class="pl-e">SampleListener</span> {
    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">pre</span>(<span class="pl-smi">SampleContext</span> <span class="pl-v">context</span>, <span class="pl-smi">Activity</span> <span class="pl-v">activity</span>) {
        <span class="pl-c">// called once per sample, beginning of each sample</span>
        <span class="pl-c">// set activity to NOOP to disable further sampling</span>
        <span class="pl-c">// no other attribute will be sampled during current sample</span>
        <span class="pl-k">if</span> (some<span class="pl-k">-</span>condition) {
            activity<span class="pl-k">.</span>setType(<span class="pl-smi">OpType</span><span class="pl-c1"><span class="pl-k">.</span>NOOP</span>);
        }
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">boolean</span> <span class="pl-en">sample</span>(<span class="pl-smi">SampleContext</span> <span class="pl-v">context</span>, <span class="pl-smi">AttributeSample</span> <span class="pl-v">sample</span>) {
        <span class="pl-c">// called once per sampled attribute</span>
        <span class="pl-c">// return false to skip this attribute from sampling collection</span>
        <span class="pl-k">if</span> (some<span class="pl-k">-</span>condition) {
            <span class="pl-k">return</span> <span class="pl-c1">false</span>;
        }
        <span class="pl-k">return</span> <span class="pl-c1">true</span>;
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">error</span>(<span class="pl-smi">SampleContext</span> <span class="pl-v">context</span>, <span class="pl-smi">AttributeSample</span> <span class="pl-v">sample</span>) {
        <span class="pl-c">// called once for every exception that occurs during each sample</span>
        <span class="pl-smi">Throwable</span> ex <span class="pl-k">=</span> sample<span class="pl-k">.</span>getError();
        ex<span class="pl-k">.</span>printStackTrace();
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">post</span>(<span class="pl-smi">SampleContext</span> <span class="pl-v">context</span>, <span class="pl-smi">Activity</span> <span class="pl-v">activity</span>) {
        <span class="pl-c">// called once per sample, end of each sample</span>
        <span class="pl-c">// set activity to NOOP to disable sampling reporting</span>
        <span class="pl-k">if</span> (some<span class="pl-k">-</span>condition) {
            activity<span class="pl-k">.</span>setType(<span class="pl-smi">OpType</span><span class="pl-c1"><span class="pl-k">.</span>NOOP</span>);
        }
    }
}</pre></div>

<h2>
<a id="conditions-and-actions" class="anchor" href="#conditions-and-actions" aria-hidden="true"><span class="octicon octicon-link"></span></a>Conditions and Actions</h2>

<p>Stream-JMX allows you to associate conditions with user defined actions based on values of MBean attributes on each sampling
interval. For example, what if you wanted to setup an action when a specific MBean attribute exceeds a certain threshold?</p>

<p>Stream-JMX <code>AttributeCondition</code> and <code>AttributeAction</code> interfaces allow you to call your action at runtime every time a condition is evaluated to true. See example below:</p>

<div class="highlight highlight-java"><pre><span class="pl-c">// return default or user defined SamplerFactory implementation</span>
<span class="pl-smi">SamplerFactory</span> factory <span class="pl-k">=</span> <span class="pl-smi">DefaultSamplerFactory</span><span class="pl-k">.</span>getInstance();
<span class="pl-c">// create an instance of the sampler that will sample mbeans</span>
<span class="pl-smi">Sampler</span> sampler <span class="pl-k">=</span> factory<span class="pl-k">.</span>newInstance();
<span class="pl-c">// create a condition when ThreadCount &gt; 100</span>
<span class="pl-smi">AttributeCondition</span> myCondition <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">SimpleCondition</span>(<span class="pl-s"><span class="pl-pds">"</span>java.lang:type=Threading<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>ThreadCount<span class="pl-pds">"</span></span>, <span class="pl-c1">100</span>, <span class="pl-s"><span class="pl-pds">"</span>&gt;<span class="pl-pds">"</span></span>);
<span class="pl-c">// schedule collection (ping) for given MBean filter and 30000 ms sampling period</span>
sampler<span class="pl-k">.</span>setSchedule(<span class="pl-smi">Sampler</span><span class="pl-c1"><span class="pl-k">.</span>JMX_FILTER_ALL</span>, <span class="pl-c1">30000</span>)<span class="pl-k">.</span>register(myCondition, <span class="pl-k">new</span> <span class="pl-smi">MyAttributeAction</span>())<span class="pl-k">.</span>run();</pre></div>

<p>Below is a sample of what <code>MyAttributeAction</code> may look like:</p>

<div class="highlight highlight-java"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">MyAttributeAction</span> <span class="pl-k">implements</span> <span class="pl-e">AttributeAction</span> {
    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-smi">Object</span> <span class="pl-en">action</span>(<span class="pl-smi">SampleContext</span> <span class="pl-v">context</span>, <span class="pl-smi">AttributeCondition</span> <span class="pl-v">cond</span>, <span class="pl-smi">AttributeSample</span> <span class="pl-v">sample</span>) {
        <span class="pl-smi">Activity</span> activity <span class="pl-k">=</span> sample<span class="pl-k">.</span>getActivity();
        <span class="pl-c">// obtain a collection of all sampled metrics</span>
        <span class="pl-k">Collection&lt;<span class="pl-smi">Snapshot</span>&gt;</span> metrics <span class="pl-k">=</span> activity<span class="pl-k">.</span>getSnapshots();
        <span class="pl-smi">System</span><span class="pl-k">.</span>out<span class="pl-k">.</span>println(<span class="pl-s"><span class="pl-pds">"</span>Myaction called with value=<span class="pl-pds">"</span></span> <span class="pl-k">+</span> sample<span class="pl-k">.</span>get()
            <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span>, age.usec=<span class="pl-pds">"</span></span> <span class="pl-k">+</span> sample<span class="pl-k">.</span>ageUsec()
            <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span>, count=<span class="pl-pds">"</span></span> <span class="pl-k">+</span> metrics<span class="pl-k">.</span>size());
        <span class="pl-k">return</span> <span class="pl-c1">null</span>;
    }
}</pre></div>

<h1>
<a id="project-dependencies" class="anchor" href="#project-dependencies" aria-hidden="true"><span class="octicon octicon-link"></span></a>Project Dependencies</h1>

<p>Stream-JMX requires the following:</p>

<ul>
<li>JDK 1.6+</li>
<li>TNT4J (<a href="https://github.com/Nastel/TNT4J">https://github.com/Nastel/TNT4J</a>)</li>
</ul>

<h1>
<a id="related-projects" class="anchor" href="#related-projects" aria-hidden="true"><span class="octicon octicon-link"></span></a>Related Projects</h1>

<ul>
<li>TrackingFilter (<a href="http://nastel.github.io/TrackingFilter/">http://nastel.github.io/TrackingFilter/</a>)</li>
<li>JESL (<a href="http://nastel.github.io/JESL/">http://nastel.github.io/JESL/</a>)</li>
</ul>

<h1>
<a id="available-integrations" class="anchor" href="#available-integrations" aria-hidden="true"><span class="octicon octicon-link"></span></a>Available Integrations</h1>

<ul>
<li>TNT4J (<a href="https://github.com/Nastel/TNT4J">https://github.com/Nastel/TNT4J</a>)</li>
<li>jkoolcloud.com (<a href="https://www.jkoolcloud.com">https://www.jkoolcloud.com</a>)</li>
<li>AutoPilot M6 (<a href="http://www.nastel.com/products/autopilot-m6.html">http://www.nastel.com/products/autopilot-m6.html</a>)</li>
</ul>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/Nastel/tnt4j-stream-jmx">Stream-JMX</a> is maintained by <a href="https://github.com/Nastel">Nastel</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
